{% extends "base.html" %}
{% block title %}Экспорт XLSX{% endblock %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-lg-8">
    <div class="card shadow-sm">
      <div class="card-body">
        <h1 class="h4">Экспорт отчёта XLSX</h1>
        <div class="text-muted mb-3">Доступно только администратору (staff).</div>

        <form method="post">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label">Таблица</label>
            <select class="form-select" name="model" id="model">
              {% for key, m in models.items %}
                <option value="{{ key }}">{{ m.label }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Поля</label>
            <div id="fields" class="row row-cols-1 row-cols-md-2 g-2">
              {% for key, m in models.items %}
                <template data-model="{{ key }}">
                  {% for f in m.fields %}
                    <div class="col">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="fields" value="{{ f }}" id="{{ key }}_{{ f }}" checked>
                        <label class="form-check-label" for="{{ key }}_{{ f }}">{{ f }}</label>
                      </div>
                    </div>
                  {% endfor %}
                </template>
              {% endfor %}
            </div>
            <div class="text-muted small mt-2">
              Можно снять галочки и выгрузить только нужные атрибуты.
            </div>
          </div>

          <button class="btn btn-primary" type="submit">Скачать XLSX</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const modelSelect = document.getElementById('model');
  const fieldsBox = document.getElementById('fields');

  function renderFields(modelKey){
    fieldsBox.innerHTML = '';
    const tpl = document.querySelector('template[data-model="' + modelKey + '"]');
    if (!tpl) return;
    fieldsBox.appendChild(tpl.content.cloneNode(true));
  }

  renderFields(modelSelect.value);
  modelSelect.addEventListener('change', () => renderFields(modelSelect.value));
})();
</script>
{% endblock %}
